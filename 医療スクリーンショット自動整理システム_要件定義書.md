# 医療スクリーンショット自動整理システム 要件定義書

**作成日**: 2025-12-28
**バージョン**: 1.0
**プロジェクト名**: MedScreenArchiver

---

## 1. システム概要

### 1.1 目的
医療スライド・論文作成のためのスクリーンショットを自動的に解析し、テキストデータとして整理・検索可能な形で保存するシステム。画像データは確認後に不要なものは削除し、軽量で管理しやすい資料庫を構築する。

### 1.2 想定ユーザー
- 医師（婦人科専門医）
- 医療スライド・論文作成者

### 1.3 主な機能
- スクリーンショットの自動検知と解析
- AIによる内容の自動分類・整理
- 患者個人情報の自動マスキング（性別・年齢のみ保持）
- フルテキスト検索とメタデータ検索
- 同一キーワードの古い資料の通知
- 出典情報の自動抽出と管理
- 古い情報への自動フラグ付け

---

## 2. 機能要件

### 2.1 スクリーンショット検知機能

#### 2.1.1 監視対象
- **監視フォルダ**: `~/Desktop/Screenshots` または macOS デフォルトのスクリーンショット保存先
- **対応形式**: PNG, JPG, JPEG
- **動作モード**: リアルタイム監視（ファイルシステムイベント監視）

#### 2.1.2 検知プロセス
1. 新規画像ファイルの検知
2. 5秒間の待機（連続スクリーンショット対応）
3. 自動解析処理の開始

### 2.2 画像解析機能

#### 2.2.1 使用技術
- **AI API**: Claude API (Anthropic)
- **処理内容**:
  - OCR（文字認識）
  - 画像内容の理解と要約
  - 医学用語の抽出
  - 出典情報の抽出（学会名、論文タイトル、著者、発表年など）
  - カテゴリの推定（疾患名、診療科、資料タイプなど）
  - **患者個人情報の検出とマスキング**:
    - 氏名、生年月日、患者ID等を自動検出して削除
    - 性別と年齢のみを保持

#### 2.2.2 抽出情報
- **テキスト**: 画像内の全文字情報（個人情報マスキング済み）
- **構造化データ**: 表やグラフは特徴をテキストで記述（詳細が必要な場合は画像を保存）
- **メタデータ**:
  - キーワード（疾患名、薬剤名、手技名など）
  - カテゴリ（婦人科/GSM関連、婦人科/骨盤臓器脱、など）
  - 出典情報（学会、論文、教科書など）
  - 症例情報（性別・年齢のみ、個人特定情報は除外）
  - 日時（スクリーンショット取得日時）

### 2.3 自動分類機能

#### 2.3.1 分類ロジック
- AIが内容を解析し、適切なカテゴリフォルダに自動配置
- 医学用語辞書を参照して分類精度を向上
- 複数カテゴリに該当する場合は、主カテゴリに保存しタグで関連付け

#### 2.3.2 フォルダ構造（例）
```
~/Desktop/医療スライド・論文作成資料/
├── 婦人科/
│   ├── GSM関連/
│   ├── 骨盤臓器脱/
│   ├── 更年期障害/
│   └── その他/
├── 産科/
├── 泌尿器科/
├── 一般/
├── 未分類/
└── _archives/
    └── images/  # 保存必要と判断された画像のみ
```

### 2.4 データ保存機能

#### 2.4.1 保存形式
- **Markdownファイル**: 抽出内容のメイン保存形式
- **SQLiteデータベース**: 検索用メタデータ
- **元画像**: ユーザー確認後、必要なもののみ保存

#### 2.4.2 Markdownファイル構造
```markdown
# [疾患名/トピック] - YYYYMMDD

**取得日時**: 2025-12-28 14:30:00
**カテゴリ**: 婦人科/GSM関連
**出典**: 第XX回日本婦人科学会 / 〇〇論文名 (2024)
**症例情報**: 女性、65歳
**キーワード**: #GSM #エストロゲン #骨盤底筋
**画像保存**: あり / なし

---

## 内容

[AIが抽出・整形したテキスト内容]

---

## メモ

[ユーザーが後から追記できるメモ欄]
```

#### 2.4.3 データベーススキーマ
```sql
CREATE TABLE screenshots (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_path TEXT NOT NULL,
    md_path TEXT NOT NULL,
    image_path TEXT,
    created_at DATETIME NOT NULL,
    category TEXT,
    keywords TEXT,  -- JSON配列
    source_info TEXT,  -- JSON形式の出典情報
    case_info TEXT,  -- 症例情報（性別・年齢のみ）
    summary TEXT,
    needs_review BOOLEAN DEFAULT 0,  -- 古い情報フラグ
    has_similar_old BOOLEAN DEFAULT 0,  -- 同一キーワードの古い資料フラグ
    last_updated DATETIME
);

CREATE VIRTUAL TABLE screenshots_fts USING fts5(
    content,
    tokenize = 'unicode61'
);
```

### 2.5 類似資料通知機能

#### 2.5.1 検出ロジック
- 新規保存時に、同一カテゴリ・同一キーワードの既存データを検索
- 1年以上前の類似資料がある場合、通知を表示
- 検出された場合、両方のファイルに関連資料リンクを追加

#### 2.5.2 表示方法
- Markdownファイルの冒頭に情報セクションを追加
```markdown
---
📚 **同じトピックの過去資料があります**

- [関連資料1](../GSM関連/20231225_エストロゲン療法.md) (2023年12月)
- 最新の知見と比較することをお勧めします
---
```

### 2.6 情報鮮度管理機能

#### 2.6.1 自動フラグ付け
- 2年以上前の情報に自動で「要確認」フラグ
- 定期実行（週次）でデータベースをスキャン

#### 2.6.2 表示方法
```markdown
---
🕐 **この情報は2年以上前のものです**
最新の知見を確認することをお勧めします。
---
```

### 2.7 検索機能

#### 2.7.1 検索インターフェース
- CLI（コマンドライン）での検索コマンド
- オプション: Web UI（将来拡張）

#### 2.7.2 検索種別
- **フルテキスト検索**: 内容全体から検索
- **キーワード検索**: タグ・キーワードで検索
- **カテゴリ検索**: フォルダ・分類で絞り込み
- **日付範囲検索**: 特定期間の情報を抽出
- **出典検索**: 学会名・論文名で検索
- **類似資料検索**: 同一トピックの資料一覧表示

#### 2.7.3 検索コマンド例
```bash
# フルテキスト検索
medscreen search "GSM エストロゲン"

# カテゴリ + キーワード
medscreen search --category "婦人科/GSM関連" --keyword "骨盤底筋"

# 日付範囲
medscreen search --from 2025-01-01 --to 2025-12-31

# 類似資料一覧
medscreen search --keyword "GSM" --show-related

# 要確認情報のみ
medscreen search --needs-review
```

### 2.8 画像管理機能

#### 2.8.1 処理フロー
1. スクリーンショット解析完了後、一時フォルダに保存
2. Markdown生成後、ユーザーに通知
3. ユーザーが手動で「保存」または「削除」を選択
4. 保存が選択された画像のみ、アーカイブフォルダに移動

#### 2.8.2 保存判断基準（推奨）
以下の場合は画像保存を推奨:
- 画像・図表・グラフが含まれる
- テキストのみでは情報が不完全
- 手術手技の写真など視覚情報が重要
- 解剖学的な構造図や画像所見

### 2.9 通知機能

#### 2.9.1 通知タイミング
- スクリーンショット解析完了時
- 同一キーワードの古い資料検出時

#### 2.9.2 通知方法
- macOS通知センター
- ログファイルへの記録

---

## 3. 非機能要件

### 3.1 性能要件
- 画像解析: 1枚あたり10秒以内
- 検索応答: 1秒以内（1000件のデータベース）
- 監視遅延: ファイル検知から5秒以内に処理開始

### 3.2 セキュリティ要件
- Claude API キーは環境変数またはキーチェーンで管理
- **患者個人情報の自動マスキング**:
  - 氏名、生年月日、患者ID等を自動検出して削除
  - 性別と年齢のみを保持
- ローカル処理を基本とし、クラウドには最小限の情報のみ送信

### 3.3 可用性
- オフライン時はキューに保存し、オンライン復帰時に処理
- エラー発生時も元画像は削除せず、手動確認可能とする

### 3.4 保守性
- モジュール分割された構造
- ログファイルによるトラブルシューティング支援
- 設定ファイルによる柔軟なカスタマイズ

---

## 4. システム構成

### 4.1 開発言語・フレームワーク
- **言語**: Python 3.10+
- **主要ライブラリ**:
  - `anthropic`: Claude API クライアント
  - `watchdog`: ファイルシステム監視
  - `sqlite3`: データベース
  - `markdown`: Markdown生成
  - `click`: CLIインターフェース
  - `pillow`: 画像処理（サイズ最適化）

### 4.2 ディレクトリ構成
```
medical-screenshot-archiver/
├── src/
│   ├── main.py                  # エントリーポイント
│   ├── monitor.py               # ファイル監視
│   ├── analyzer.py              # 画像解析（Claude API）
│   ├── privacy.py               # 個人情報マスキング
│   ├── classifier.py            # 自動分類
│   ├── database.py              # DB操作
│   ├── similar_detector.py      # 類似資料検出
│   ├── search.py                # 検索機能
│   ├── image_manager.py         # 画像管理（保存・削除）
│   └── utils.py                 # ユーティリティ
├── config/
│   └── config.yaml              # 設定ファイル
├── data/
│   └── medical_terms.json       # 医学用語辞書
├── logs/
├── tests/
├── requirements.txt
└── README.md
```

### 4.3 設定ファイル（config.yaml）
```yaml
# 監視設定
monitor:
  watch_folder: "~/Desktop/Screenshots"
  file_types: [".png", ".jpg", ".jpeg"]
  wait_seconds: 5

# 保存設定
storage:
  base_folder: "~/Desktop/医療スライド・論文作成資料"
  temp_folder: "~/Desktop/医療スライド・論文作成資料/_temp"
  archive_images: true

# AI設定
ai:
  provider: "anthropic"
  model: "claude-3-5-sonnet-20241022"
  max_tokens: 4096

# 分類設定
classification:
  categories:
    - "婦人科/GSM関連"
    - "婦人科/骨盤臓器脱"
    - "婦人科/更年期障害"
    - "産科"
    - "泌尿器科"
    - "一般"

# 類似資料検出設定
similar_detection:
  enabled: true
  similarity_threshold: 0.7
  old_resource_months: 12  # 何ヶ月以前を「古い資料」とするか

# 情報鮮度管理
freshness:
  warning_years: 2
  check_interval_days: 7

# 通知設定
notification:
  enabled: true
  method: "macos"  # or "email"
```

---

## 5. 運用フロー

### 5.1 初回セットアップ
1. リポジトリクローン
2. 依存パッケージインストール: `pip install -r requirements.txt`
3. Claude API キー設定: `export ANTHROPIC_API_KEY="sk-..."`
4. 設定ファイル編集: `config/config.yaml`
5. データベース初期化: `python src/main.py init`
6. 監視開始: `python src/main.py start`

### 5.2 日常運用
1. システム起動（バックグラウンド実行）
2. スクリーンショットを通常通り取得
3. 自動で解析・保存（通知で確認）
4. 画像の保存・削除を手動で判断
5. 必要に応じて検索: `medscreen search "キーワード"`
6. 週次で類似資料・要確認情報をレビュー

### 5.3 定期メンテナンス
- 月次: 画像アーカイブの整理
- 四半期: 古い情報の見直し
- 年次: カテゴリ構成の見直し

---

## 6. リスクと対策

### 6.1 リスク一覧

| リスク | 影響度 | 対策 |
|--------|--------|------|
| Claude API の利用料金増加 | 中 | 画像サイズの最適化、バッチ処理の導入 |
| 誤分類による情報の散逸 | 中 | 手動での再分類機能、検索による補完 |
| 個人情報の検出漏れ | 高 | AIによる自動マスキング + ユーザーによる最終確認 |
| API障害時の処理停止 | 低 | オフラインキュー、手動処理への切り替え |
| マスキング過剰による情報損失 | 中 | マスキング前後のプレビュー表示、手動調整機能 |

### 6.2 将来的な拡張性
- Web UIの追加
- チーム共有機能（クラウドストレージ連携）
- スマートフォンからのスクリーンショット自動同期
- 自動プレゼンテーション生成機能

---

## 7. 成功基準

### 7.1 定量的指標
- スクリーンショットの自動解析成功率: 95%以上
- 分類精度: 90%以上
- 検索応答時間: 1秒以内
- ストレージ削減率: 70%以上（画像削除による）

### 7.2 定性的指標
- スライド作成時の資料検索時間の短縮
- 過去の情報への容易なアクセス
- 個人情報保護の徹底
- 類似資料の効率的な比較

---

## 8. スケジュール（概算）

| フェーズ | 期間 | 主な作業 |
|----------|------|----------|
| 要件定義 | 完了 | 本ドキュメント作成 |
| 基本設計 | 1日 | アーキテクチャ設計、DB設計 |
| 実装（コア機能） | 3-4日 | 監視、解析、個人情報マスキング、保存機能 |
| 実装（検索・類似検出） | 2-3日 | 検索機能、類似資料検出機能 |
| 実装（画像管理） | 1日 | 画像保存・削除インターフェース |
| テスト | 2日 | 単体テスト、統合テスト、個人情報マスキングテスト |
| ドキュメント整備 | 1日 | README、運用マニュアル |
| **合計** | **約10-12日** | |

---

## 9. 承認

本要件定義書の内容について確認し、承認します。

- 作成者: Claude (AI Assistant)
- レビュー者: Dr. Ninomiya
- 承認日: ___________

---

**付録A: 医学用語辞書サンプル**
```json
{
  "diseases": ["GSM", "骨盤臓器脱", "更年期障害", "子宮筋腫"],
  "treatments": ["エストロゲン療法", "ホルモン補充療法", "骨盤底筋訓練"],
  "specialties": ["婦人科", "産科", "泌尿器科"]
}
```

**付録B: API使用量見積もり**
- 1画像あたりの平均トークン数: 1500トークン（入力） + 1000トークン（出力）
- 1日のスクリーンショット数（想定）: 10枚
- 月間推定コスト: 約$15-30（Claude 3.5 Sonnet使用時）
